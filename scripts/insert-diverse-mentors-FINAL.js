#!/usr/bin/env node

/**
 * Script para inserir mentores diversos no Supabase remoto
 * Baseado na estrutura REAL das tabelas do banco de produ√ß√£o
 * 
 * Estrutura da tabela profiles (campos relevantes):
 * - first_name, last_name (full_name √© GENERATED)
 * - bio, avatar_url, slug
 * - job_title, company, experience_years
 * - city, state, country, timezone
 * - languages (TEXT[])
 * - mentorship_topics (TEXT[])
 * - expertise_areas (TEXT[])
 * - inclusive_tags (TEXT[])
 * - session_price_usd (DECIMAL)
 * - availability_status (TEXT: 'available', 'busy', 'unavailable')
 * - linkedin_url, github_url, twitter_url, website_url, phone
 */

const { createClient } = require('@supabase/supabase-js')
require('dotenv').config({ path: '.env.production' })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

console.log('üîó Conectando ao Supabase:', supabaseUrl)

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Erro: Vari√°veis de ambiente n√£o configuradas')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseServiceKey)

// Mentores diversos - ESTRUTURA CORRETA
const diverseMentors = [
  {
    email: 'ana.ferreira.pedagoga.2024@menvo.com.br',
    first_name: 'Ana Paula',
    last_name: 'Ferreira',
    bio: 'Pedagoga com 15 anos de experi√™ncia em educa√ß√£o infantil e fundamental. Apaixonada por metodologias ativas e inclus√£o escolar.',
    job_title: 'Professora Pedagoga',
    company: 'Escola Municipal Santos Dumont',
    mentorship_topics: ['Educa√ß√£o', 'Pedagogia', 'Metodologias Ativas', 'Inclus√£o Escolar', 'Alfabetiza√ß√£o'],
    expertise_areas: ['Educa√ß√£o Infantil', 'Psicopedagogia', 'Gest√£o de Sala de Aula', 'Educa√ß√£o Inclusiva'],
    inclusive_tags: ['Mulheres', 'Educa√ß√£o P√∫blica'],
    languages: ['Portugu√™s'],
    city: 'S√£o Paulo',
    state: 'SP',
    country: 'Brasil',
    experience_years: 15,
    session_price_usd: 20
  },
  {
    email: 'roberto.oliveira.corredor.2024@menvo.com.br',
    first_name: 'Roberto',
    last_name: 'Silva Oliveira',
    bio: 'Corredor amador h√° 8 anos, completei 5 maratonas e dezenas de meias maratonas. Transformei minha vida atrav√©s da corrida.',
    job_title: 'Corredor Amador e Coach',
    company: 'Assessoria Esportiva Vida Ativa',
    mentorship_topics: ['Corrida', 'Sa√∫de', 'Bem-estar', 'Supera√ß√£o', 'Disciplina'],
    expertise_areas: ['Corrida de Rua', 'Prepara√ß√£o para Maratonas', 'Nutri√ß√£o Esportiva', 'Motiva√ß√£o'],
    inclusive_tags: ['Esportes', 'Sa√∫de'],
    languages: ['Portugu√™s'],
    city: 'Rio de Janeiro',
    state: 'RJ',
    country: 'Brasil',
    experience_years: 8,
    session_price_usd: 15
  },
  {
    email: 'juliana.rodrigues.costureira.2024@menvo.com.br',
    first_name: 'Juliana',
    last_name: 'Alves Rodrigues',
    bio: 'Costureira profissional h√° 20 anos, especializada em alta costura e ajustes. Transformei meu ateli√™ em um neg√≥cio pr√≥spero.',
    job_title: 'Costureira e Propriet√°ria',
    company: 'Ateli√™ Juliana Alves',
    mentorship_topics: ['Costura', 'Moda', 'Empreendedorismo', 'Artesanato', 'Neg√≥cios Criativos'],
    expertise_areas: ['Alta Costura', 'Modelagem', 'Ajustes', 'Gest√£o de Ateli√™'],
    inclusive_tags: ['Mulheres', 'Empreendedoras', 'Artesanato'],
    languages: ['Portugu√™s'],
    city: 'Curitiba',
    state: 'PR',
    country: 'Brasil',
    experience_years: 20,
    session_price_usd: 12
  },
  {
    email: 'joao.martins.artesao.2024@menvo.com.br',
    first_name: 'Jo√£o Pedro',
    last_name: 'Martins',
    bio: 'Artes√£o especializado em marcenaria e trabalhos em madeira. Ajudo artes√£os a profissionalizarem seu trabalho.',
    job_title: 'Artes√£o e Marceneiro',
    company: 'Oficina JP Madeiras',
    mentorship_topics: ['Artesanato', 'Marcenaria', 'Empreendedorismo', 'Vendas Online', 'Criatividade'],
    expertise_areas: ['Marcenaria', 'Trabalho em Madeira', 'Design de M√≥veis', 'E-commerce'],
    inclusive_tags: ['Artesanato', 'Empreendedores'],
    languages: ['Portugu√™s'],
    city: 'Porto Alegre',
    state: 'RS',
    country: 'Brasil',
    experience_years: 18,
    session_price_usd: 10
  },
  {
    email: 'antonio.pereira.pescador.2024@menvo.com.br',
    first_name: 'Ant√¥nio Carlos',
    last_name: 'Pereira',
    bio: 'Pescador artesanal h√° 25 anos. Luto pela preserva√ß√£o da pesca artesanal e ensino t√©cnicas sustent√°veis.',
    job_title: 'Pescador Artesanal',
    company: 'Col√¥nia de Pescadores Z-10',
    mentorship_topics: ['Pesca Artesanal', 'Sustentabilidade', 'Tradi√ß√µes', 'Vida no Mar', 'Comunidade'],
    expertise_areas: ['Pesca Sustent√°vel', 'Navega√ß√£o', 'Preserva√ß√£o Marinha', 'Organiza√ß√£o Comunit√°ria'],
    inclusive_tags: ['Trabalhadores Tradicionais', 'Sustentabilidade'],
    languages: ['Portugu√™s'],
    city: 'Salvador',
    state: 'BA',
    country: 'Brasil',
    experience_years: 25,
    session_price_usd: 8
  },
  {
    email: 'paulo.souza.taxista.2024@menvo.com.br',
    first_name: 'Paulo Henrique',
    last_name: 'Souza',
    bio: 'Motorista de t√°xi h√° 16 anos. Aprendi muito sobre relacionamento com clientes e gest√£o do pr√≥prio neg√≥cio.',
    job_title: 'Motorista de T√°xi Aut√¥nomo',
    company: 'Cooperativa de T√°xi Unidos',
    mentorship_topics: ['Trabalho Aut√¥nomo', 'Atendimento ao Cliente', 'Gest√£o Financeira', 'Empreendedorismo'],
    expertise_areas: ['Transporte Urbano', 'Relacionamento com Cliente', 'Gest√£o de Neg√≥cio Pr√≥prio', 'Cooperativismo'],
    inclusive_tags: ['Trabalhadores Aut√¥nomos', 'Empreendedores'],
    languages: ['Portugu√™s'],
    city: 'Recife',
    state: 'PE',
    country: 'Brasil',
    experience_years: 16,
    session_price_usd: 10
  },
  {
    email: 'fernando.costa.caminhoneiro.2024@menvo.com.br',
    first_name: 'Fernando',
    last_name: 'Almeida Costa',
    bio: 'Caminhoneiro h√° 22 anos, rodei o Brasil inteiro. Oriento sobre carreira no transporte de cargas e seguran√ßa.',
    job_title: 'Motorista de Caminh√£o',
    company: 'Transportadora Rotas do Brasil',
    mentorship_topics: ['Transporte de Cargas', 'Vida na Estrada', 'Seguran√ßa', 'Log√≠stica', 'Resili√™ncia'],
    expertise_areas: ['Dire√ß√£o Defensiva', 'Log√≠stica de Transporte', 'Manuten√ß√£o de Ve√≠culos', 'Gest√£o de Tempo'],
    inclusive_tags: ['Trabalhadores do Transporte'],
    languages: ['Portugu√™s'],
    city: 'Campinas',
    state: 'SP',
    country: 'Brasil',
    experience_years: 22,
    session_price_usd: 12
  },
  {
    email: 'patricia.silva.telemarketing.2024@menvo.com.br',
    first_name: 'Patr√≠cia',
    last_name: 'Mendes Silva',
    bio: 'Operadora de telemarketing h√° 9 anos, me tornei supervisora. Ajudo profissionais de call center a crescerem.',
    job_title: 'Supervisora de Telemarketing',
    company: 'Contact Center Solutions',
    mentorship_topics: ['Telemarketing', 'Comunica√ß√£o', 'Vendas', 'Gest√£o de Estresse', 'Carreira'],
    expertise_areas: ['Atendimento ao Cliente', 'T√©cnicas de Vendas', 'Gest√£o de Equipes', 'Comunica√ß√£o Assertiva'],
    inclusive_tags: ['Mulheres', 'Atendimento'],
    languages: ['Portugu√™s'],
    city: 'Fortaleza',
    state: 'CE',
    country: 'Brasil',
    experience_years: 9,
    session_price_usd: 15
  },
  {
    email: 'camila.santos.manicure.2024@menvo.com.br',
    first_name: 'Camila',
    last_name: 'Rodrigues Santos',
    bio: 'Manicure e nail designer h√° 11 anos. Transformei minha paix√£o por unhas em um neg√≥cio lucrativo.',
    job_title: 'Manicure e Nail Designer',
    company: 'Studio Camila Nails',
    mentorship_topics: ['Beleza', 'Nail Art', 'Empreendedorismo', 'Atendimento', 'Marketing Pessoal'],
    expertise_areas: ['Manicure', 'Nail Design', 'Gest√£o de Sal√£o', 'Redes Sociais'],
    inclusive_tags: ['Mulheres', 'Empreendedoras', 'Beleza'],
    languages: ['Portugu√™s'],
    city: 'Goi√¢nia',
    state: 'GO',
    country: 'Brasil',
    experience_years: 11,
    session_price_usd: 10
  },
  {
    email: 'ricardo.lima.barbeiro.2024@menvo.com.br',
    first_name: 'Ricardo',
    last_name: 'Barbosa Lima',
    bio: 'Barbeiro profissional h√° 14 anos. Constru√≠ uma clientela fiel atrav√©s de excel√™ncia no atendimento.',
    job_title: 'Barbeiro e Propriet√°rio',
    company: 'Barbearia Cl√°ssica',
    mentorship_topics: ['Barbearia', 'Empreendedorismo', 'Atendimento', 'T√©cnicas de Corte', 'Gest√£o'],
    expertise_areas: ['Cortes Masculinos', 'Barba', 'Gest√£o de Barbearia', 'Fideliza√ß√£o de Clientes'],
    inclusive_tags: ['Empreendedores', 'Beleza'],
    languages: ['Portugu√™s'],
    city: 'Manaus',
    state: 'AM',
    country: 'Brasil',
    experience_years: 14,
    session_price_usd: 12
  },
  {
    email: 'lucas.oliveira.bombeiro.2024@menvo.com.br',
    first_name: 'Lucas',
    last_name: 'Fernandes Oliveira',
    bio: 'Bombeiro civil h√° 10 anos. Sou instrutor de primeiros socorros e seguran√ßa do trabalho.',
    job_title: 'Bombeiro Civil',
    company: 'Corpo de Bombeiros Industrial',
    mentorship_topics: ['Seguran√ßa', 'Primeiros Socorros', 'Preven√ß√£o', 'Lideran√ßa', 'Trabalho em Equipe'],
    expertise_areas: ['Combate a Inc√™ndio', 'Primeiros Socorros', 'Seguran√ßa do Trabalho', 'Resgate'],
    inclusive_tags: ['Seguran√ßa', 'Servi√ßos Essenciais'],
    languages: ['Portugu√™s'],
    city: 'Vit√≥ria',
    state: 'ES',
    country: 'Brasil',
    experience_years: 10,
    session_price_usd: 18
  },
  {
    email: 'jose.ribeiro.churros.2024@menvo.com.br',
    first_name: 'Jos√© Carlos',
    last_name: 'Ribeiro',
    bio: 'Vendedor de churros h√° 13 anos, comecei com um carrinho e hoje tenho 3 pontos de venda.',
    job_title: 'Empreendedor - Food Service',
    company: 'Churros do Z√©',
    mentorship_topics: ['Empreendedorismo', 'Food Service', 'Vendas', 'Atendimento', 'Gest√£o Financeira'],
    expertise_areas: ['Com√©rcio de Rua', 'Gest√£o de Neg√≥cio Pr√≥prio', 'Atendimento ao Cliente', 'Expans√£o de Neg√≥cios'],
    inclusive_tags: ['Empreendedores', 'Com√©rcio'],
    languages: ['Portugu√™s'],
    city: 'Florian√≥polis',
    state: 'SC',
    country: 'Brasil',
    experience_years: 13,
    session_price_usd: 10
  }
]

async function insertMentor(mentorData) {
  const { email, first_name, last_name, ...profileData } = mentorData
  
  try {
    console.log(`\nüìù Processando: ${first_name} ${last_name}...`)
    
    // 1. Criar usu√°rio de autentica√ß√£o
    const { data: authData, error: authError } = await supabase.auth.admin.createUser({
      email,
      email_confirm: true,
      user_metadata: {
        first_name,
        last_name
      }
    })

    if (authError) {
      if (authError.message.includes('already been registered')) {
        console.log(`   ‚ö†Ô∏è  Email j√° existe, atualizando perfil...`)
        
        // Buscar usu√°rio existente
        const { data: { users } } = await supabase.auth.admin.listUsers()
        const existingUser = users.find(u => u.email === email)
        
        if (!existingUser) {
          console.log(`   ‚ùå Usu√°rio n√£o encontrado`)
          return { success: false, reason: 'user_not_found' }
        }
        
        // Atualizar perfil existente
        const { error: updateError } = await supabase
          .from('profiles')
          .update({
            first_name,
            last_name,
            ...profileData,
            availability_status: 'busy'
          })
          .eq('id', existingUser.id)
        
        if (updateError) {
          console.log(`   ‚ùå Erro ao atualizar: ${updateError.message}`)
          return { success: false, reason: updateError.message }
        }
        
        // Adicionar role de mentor
        const { error: roleError } = await supabase
          .from('user_roles')
          .insert({
            user_id: existingUser.id,
            role_id: 1 // mentor role
          })
        
        if (roleError && !roleError.message.includes('duplicate')) {
          console.log(`   ‚ö†Ô∏è  Role: ${roleError.message}`)
        }
        
        console.log(`   ‚úÖ Perfil atualizado`)
        return { success: true, userId: existingUser.id, updated: true }
      }
      throw authError
    }

    const userId = authData.user.id
    console.log(`   ‚úÖ Usu√°rio criado (ID: ${userId})`)

    // 2. Atualizar perfil
    const { error: profileError } = await supabase
      .from('profiles')
      .update({
        first_name,
        last_name,
        ...profileData,
        availability_status: 'busy'
      })
      .eq('id', userId)

    if (profileError) {
      console.log(`   ‚ùå Erro ao atualizar perfil: ${profileError.message}`)
      return { success: false, reason: profileError.message }
    }
    
    console.log(`   ‚úÖ Perfil atualizado`)

    // 3. Adicionar role de mentor
    const { error: roleError } = await supabase
      .from('user_roles')
      .insert({
        user_id: userId,
        role_id: 1 // mentor role (id=1 conforme migration)
      })

    if (roleError) {
      console.log(`   ‚ö†Ô∏è  Role: ${roleError.message}`)
    } else {
      console.log(`   ‚úÖ Role de mentor adicionada`)
    }

    console.log(`‚úÖ ${first_name} ${last_name} criado com sucesso!`)
    return { success: true, userId, created: true }

  } catch (error) {
    console.error(`‚ùå Erro: ${error.message}`)
    return { success: false, reason: error.message }
  }
}

async function main() {
  console.log('\n' + '='.repeat(60))
  console.log('üå± INSERINDO MENTORES DIVERSOS - VERS√ÉO FINAL')
  console.log('='.repeat(60))
  console.log(`\nüìä Total: ${diverseMentors.length} mentores`)
  console.log('‚ö†Ô∏è  Fotos ser√£o adicionadas manualmente depois\n')

  let created = 0
  let updated = 0
  let errors = 0

  for (const mentor of diverseMentors) {
    const result = await insertMentor(mentor)
    
    if (result.success) {
      if (result.created) created++
      if (result.updated) updated++
    } else {
      errors++
    }
    
    await new Promise(resolve => setTimeout(resolve, 500))
  }

  console.log('\n' + '='.repeat(60))
  console.log('üìä RESUMO')
  console.log('='.repeat(60))
  console.log(`‚úÖ Criados: ${created}`)
  console.log(`üîÑ Atualizados: ${updated}`)
  console.log(`‚ùå Erros: ${errors}`)
  console.log(`üìà Total: ${diverseMentors.length}`)
  console.log('='.repeat(60))
  console.log('\nüì∏ Adicione fotos em: https://randomuser.me/photos\n')
}

main().then(() => process.exit(0)).catch(err => {
  console.error('‚ùå Erro fatal:', err)
  process.exit(1)
})
