# ๐ฏ Fluxograma Completo do Sistema de Quiz - MENVO

## ๐ Visรฃo Geral do Fluxo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FRONTEND (Next.js)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    1. PรGINA INICIAL DO QUIZ                        โ
โ                      app/quiz/page.tsx                              โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข Usuรกrio clica em "Comeรงar Questionรกrio"                         โ
โ  โข Estado: showQuiz = false โ true                                 โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Renderiza <QuizForm />                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    2. COMPONENTE QUIZ FORM                          โ
โ                  components/quiz/QuizForm.tsx                       โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข Props: onSubmit, onBack                                          โ
โ  โข Estado local: formData (Partial<QuizFormData>)                  โ
โ  โข currentStep (1-8)                                                โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โข Renderiza 8 perguntas sequencialmente                           โ
โ  โข Valida cada resposta antes de avanรงar                           โ
โ  โข Armazena respostas em formData                                  โ
โ                                                                     โ
โ  PERGUNTAS:                                                         โ
โ  1. Momento de carreira (RadioGroup)                               โ
โ  2. Desafio profissional (TextareaWithVoice)                       โ
โ  3. Experiรชncia com mentoria (RadioGroup)                          โ
โ  4. Visรฃo de futuro (TextareaWithVoice)                            โ
โ  5. รreas de desenvolvimento (Checkbox mรบltiplo)                   โ
โ  6. Ajuda vida pessoal (TextareaWithVoice)                         โ
โ  7. Compartilhar conhecimento (RadioGroup)                         โ
โ  8. Dados de contato (Input: nome, email, linkedin)               โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Ao finalizar: chama onSubmit(formData)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 3. HANDLER DE SUBMIT (Frontend)                     โ
โ              app/quiz/page.tsx โ handleQuizSubmit()                 โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข data: QuizFormData (todas as respostas)                         โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 3.1. Criar cliente Supabase                             โ      โ
โ  โ      const supabase = createClient()                    โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 3.2. Inserir no banco de dados                          โ      โ
โ  โ      supabase.from("quiz_responses").insert({...})      โ      โ
โ  โ                                                          โ      โ
โ  โ      Campos salvos:                                      โ      โ
โ  โ      โข name, email, linkedin_url                         โ      โ
โ  โ      โข career_moment                                     โ      โ
โ  โ      โข mentorship_experience                             โ      โ
โ  โ      โข development_areas (array)                         โ      โ
โ  โ      โข current_challenge                                 โ      โ
โ  โ      โข future_vision                                     โ      โ
โ  โ      โข share_knowledge                                   โ      โ
โ  โ      โข personal_life_help                                โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 3.3. Enviar email de convite (fire & forget)            โ      โ
โ  โ      supabase.functions.invoke("send-invite-email")     โ      โ
โ  โ      โข Nรฃo bloqueia o fluxo                              โ      โ
โ  โ      โข Erro รฉ apenas logado                              โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 3.4. Toast de feedback                                   โ      โ
โ  โ      "Questionรกrio enviado!"                             โ      โ
โ  โ      "Processando sua anรกlise com IA..."                โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 3.5. Chamar Edge Function de anรกlise                    โ      โ
โ  โ      supabase.functions.invoke("analyze-quiz")          โ      โ
โ  โ      body: { responseId: response.id }                   โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  OUTPUT:                                                            โ
โ  โข Redireciona para: /quiz/results/{response.id}                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         BANCO DE DADOS                              โ
โ                    Supabase PostgreSQL                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  4. TABELA: quiz_responses                          โ
โ                                                                     โ
โ  ESTRUTURA:                                                         โ
โ  โข id (UUID, PK)                                                    โ
โ  โข name (text)                                                      โ
โ  โข email (text)                                                     โ
โ  โข linkedin_url (text, nullable)                                    โ
โ  โข career_moment (text)                                             โ
โ  โข mentorship_experience (text)                                     โ
โ  โข development_areas (text[])                                       โ
โ  โข current_challenge (text)                                         โ
โ  โข future_vision (text)                                             โ
โ  โข share_knowledge (text)                                           โ
โ  โข personal_life_help (text)                                        โ
โ  โข score (integer, nullable) โ calculado pela IA                   โ
โ  โข ai_analysis (jsonb, nullable) โ resultado da anรกlise            โ
โ  โข processed_at (timestamp, nullable)                               โ
โ  โข email_sent (boolean, default false)                              โ
โ  โข email_sent_at (timestamp, nullable)                              โ
โ  โข created_at (timestamp)                                           โ
โ  โข updated_at (timestamp)                                           โ
โ                                                                     โ
โ  RLS POLICIES:                                                      โ
โ  โข Public pode inserir (quiz pรบblico)                               โ
โ  โข Public pode ler por email                                        โ
โ  โข Public pode atualizar (para Edge Functions)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      EDGE FUNCTIONS (Deno)                          โ
โ                    Supabase Functions                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              5. EDGE FUNCTION: analyze-quiz                         โ
โ           supabase/functions/analyze-quiz/index.ts                  โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข body: { responseId: string }                                     โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.1. Buscar resposta do banco                            โ      โ
โ  โ      SELECT * FROM quiz_responses WHERE id = ?           โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.2. Buscar mentores disponรญveis                         โ      โ
โ  โ      SELECT * FROM profiles                              โ      โ
โ  โ      WHERE is_mentor = true                              โ      โ
โ  โ      AND availability_status = 'available'               โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.3. Gerar prompt para IA                                โ      โ
โ  โ      generateAnalysisPrompt(response, mentors)           โ      โ
โ  โ                                                          โ      โ
โ  โ      Inclui:                                             โ      โ
โ  โ      โข Todas as respostas do usuรกrio                     โ      โ
โ  โ      โข Lista de mentores reais disponรญveis               โ      โ
โ  โ      โข Instruรงรตes de anรกlise                             โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.4. Chamar OpenAI API                                   โ      โ
โ  โ      Model: gpt-4o-mini                                  โ      โ
โ  โ      Temperature: 0.7                                    โ      โ
โ  โ      Response format: JSON                               โ      โ
โ  โ                                                          โ      โ
โ  โ      Solicita:                                           โ      โ
โ  โ      โข Pontuaรงรฃo (0-1000)                                โ      โ
โ  โ      โข Tรญtulo personalizado                              โ      โ
โ  โ      โข Resumo motivador                                  โ      โ
โ  โ      โข Mentores sugeridos (com nomes reais)              โ      โ
โ  โ      โข Conselhos prรกticos                                โ      โ
โ  โ      โข Prรณximos passos                                   โ      โ
โ  โ      โข รreas de desenvolvimento                          โ      โ
โ  โ      โข Mensagem final                                    โ      โ
โ  โ      โข Potencial mentor (boolean)                        โ      โ
โ  โ      โข รreas vida pessoal                                โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.5. Fallback se IA falhar                               โ      โ
โ  โ      generateFallbackAnalysis(response, mentors)         โ      โ
โ  โ      โข Anรกlise baseada em regras                         โ      โ
โ  โ      โข Garante que sempre hรก resultado                   โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.6. Atualizar banco com anรกlise                         โ      โ
โ  โ      UPDATE quiz_responses SET                           โ      โ
โ  โ        ai_analysis = {...},                              โ      โ
โ  โ        score = pontuacao,                                โ      โ
โ  โ        processed_at = NOW()                              โ      โ
โ  โ      WHERE id = responseId                               โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 5.7. Chamar funรงรฃo de envio de email                     โ      โ
โ  โ      supabase.functions.invoke("send-quiz-email")        โ      โ
โ  โ      โข Assรญncrono, nรฃo bloqueia                          โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Status 200 + anรกlise completa                                   โ
โ  โข Ou erro com fallback                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           6. EDGE FUNCTION: send-quiz-email                         โ
โ         supabase/functions/send-quiz-email/index.ts                 โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข body: { responseId: string }                                     โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 6.1. Buscar resposta com anรกlise                         โ      โ
โ  โ      SELECT * FROM quiz_responses WHERE id = ?           โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 6.2. Verificar se jรก foi enviado                         โ      โ
โ  โ      if (email_sent) return                              โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 6.3. Montar HTML do email                                โ      โ
โ  โ      โข Tรญtulo personalizado                              โ      โ
โ  โ      โข Pontuaรงรฃo                                         โ      โ
โ  โ      โข Resumo da anรกlise                                 โ      โ
โ  โ      โข Link para ver resultado completo                  โ      โ
โ  โ      โข Brinde (se score >= 700)                          โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 6.4. Enviar via Brevo API                                โ      โ
โ  โ      POST https://api.brevo.com/v3/smtp/email            โ      โ
โ  โ      โข From: contato@menvo.com.br                        โ      โ
โ  โ      โข To: user email                                    โ      โ
โ  โ      โข Subject: "Sua Anรกlise Personalizada - MENVO"      โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 6.5. Atualizar status de envio                           โ      โ
โ  โ      UPDATE quiz_responses SET                           โ      โ
โ  โ        email_sent = true,                                โ      โ
โ  โ        email_sent_at = NOW()                             โ      โ
โ  โ      WHERE id = responseId                               โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Status 200 se sucesso                                            โ
โ  โข Erro se falhar                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           7. EDGE FUNCTION: send-invite-email                       โ
โ        supabase/functions/send-invite-email/index.ts                โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข body: { name: string, email: string }                            โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โข Envia email de boas-vindas                                       โ
โ  โข Convite para acessar plataforma MENVO                           โ
โ  โข Nรฃo bloqueia o fluxo principal                                  โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Fire & forget (erro apenas logado)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FRONTEND (Next.js)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                8. PรGINA DE RESULTADOS                              โ
โ              app/quiz/results/[id]/page.tsx                         โ
โ                                                                     โ
โ  INPUT:                                                             โ
โ  โข params.id (UUID da resposta)                                     โ
โ                                                                     โ
โ  PROCESSAMENTO:                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 8.1. useEffect ao montar                                 โ      โ
โ  โ      loadResults()                                       โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 8.2. Buscar resultado do banco                           โ      โ
โ  โ      SELECT * FROM quiz_responses WHERE id = ?           โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 8.3. Verificar se processado                             โ      โ
โ  โ      if (!processed_at) {                                โ      โ
โ  โ        setTimeout(loadResults, 2000) // retry            โ      โ
โ  โ      }                                                    โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 8.4. Renderizar anรกlise                                  โ      โ
โ  โ      โข Tรญtulo personalizado                              โ      โ
โ  โ      โข Pontuaรงรฃo                                         โ      โ
โ  โ      โข Seleรงรฃo de brinde (se >= 700)                     โ      โ
โ  โ      โข Mentores sugeridos                                โ      โ
โ  โ      โข Conselhos prรกticos                                โ      โ
โ  โ      โข Prรณximos passos                                   โ      โ
โ  โ      โข รreas de desenvolvimento                          โ      โ
โ  โ      โข Mensagem final                                    โ      โ
โ  โ      โข Badge "Potencial Mentor" (se aplicรกvel)           โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                      โ                                              โ
โ                      โผ                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ 8.5. Aรงรตes de compartilhamento                           โ      โ
โ  โ      โข Enviar por email (chama send-quiz-email)          โ      โ
โ  โ      โข Compartilhar no WhatsApp                          โ      โ
โ  โ      โข Compartilhar no LinkedIn                          โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โ  OUTPUT:                                                            โ
โ  โข Interface visual com toda anรกlise                                โ
โ  โข Opรงรตes de compartilhamento                                      โ
โ  โข Seleรงรฃo de brinde (se elegรญvel)                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


---

## ๐ Fluxo Resumido por Camadas

### ๐ฑ CAMADA DE APRESENTAรรO (Frontend)
```
app/quiz/page.tsx
    โ
components/quiz/QuizForm.tsx
    โ
app/quiz/results/[id]/page.tsx
```

**Responsabilidades:**
- Capturar input do usuรกrio (8 perguntas)
- Validar respostas antes de avanรงar
- Exibir feedback visual (toast, loading)
- Renderizar resultados da anรกlise
- Permitir compartilhamento

---

### ๐ฃ CAMADA DE HOOKS (Estado e Lรณgica)
```
hooks/useToast.ts
    โ (feedback visual)
useState/useEffect
    โ (gerenciamento de estado local)
```

**Responsabilidades:**
- Gerenciar estado do formulรกrio
- Controlar navegaรงรฃo entre perguntas
- Polling de resultados (retry se nรฃo processado)
- Feedback de loading/erro

---

### ๐ง CAMADA DE SERVIรOS (Client-side)
```
utils/supabase/client.ts
    โ (cliente Supabase)
Supabase Client API
```

**Responsabilidades:**
- Criar cliente Supabase autenticado
- Fazer queries ao banco
- Invocar Edge Functions
- Gerenciar conexรฃo

---

### ๐พ CAMADA DE BANCO DE DADOS
```
PostgreSQL (Supabase)
    โ
quiz_responses (tabela principal)
    โโ Dados do usuรกrio
    โโ Respostas do quiz
    โโ Anรกlise da IA (JSONB)
    โโ Metadados (timestamps, flags)
    
profiles (tabela de mentores)
    โโ Mentores disponรญveis para matching
```

**Responsabilidades:**
- Persistir respostas do quiz
- Armazenar anรกlise da IA
- Controlar status de processamento
- Rastrear envio de emails
- RLS para seguranรงa

---

### โก CAMADA DE EDGE FUNCTIONS (Backend Serverless)

#### Function 1: analyze-quiz
```
supabase/functions/analyze-quiz/index.ts
    โ
1. Busca resposta do banco
2. Busca mentores disponรญveis
3. Gera prompt para IA
4. Chama OpenAI API (gpt-4o-mini)
5. Processa resposta JSON
6. Fallback se IA falhar
7. Atualiza banco com anรกlise
8. Dispara envio de email
```

**Responsabilidades:**
- Orquestrar anรกlise com IA
- Fazer matching com mentores reais
- Calcular pontuaรงรฃo
- Garantir fallback
- Atualizar banco de dados

#### Function 2: send-quiz-email
```
supabase/functions/send-quiz-email/index.ts
    โ
1. Busca resposta com anรกlise
2. Verifica se jรก enviou
3. Monta HTML do email
4. Envia via Brevo API
5. Atualiza flag email_sent
```

**Responsabilidades:**
- Enviar email com resultados
- Integraรงรฃo com Brevo
- Controle de duplicaรงรฃo
- Atualizar status

#### Function 3: send-invite-email
```
supabase/functions/send-invite-email/index.ts
    โ
1. Recebe nome e email
2. Envia convite para MENVO
3. Fire & forget (nรฃo bloqueia)
```

**Responsabilidades:**
- Email de boas-vindas
- Convite para plataforma
- Nรฃo bloqueia fluxo principal

---

### ๐ค CAMADA DE IA (Serviรงo Externo)
```
OpenAI API
    โ
Model: gpt-4o-mini
Temperature: 0.7
Response: JSON estruturado
```

**Responsabilidades:**
- Analisar respostas do usuรกrio
- Gerar insights personalizados
- Sugerir mentores adequados
- Calcular pontuaรงรฃo
- Identificar potencial mentor

---

## ๐ Estrutura de Dados

### QuizFormData (Input)
```typescript
{
  careerMoment: string
  mentorshipExperience: string
  developmentAreas: string[]
  developmentAreasOther?: string
  currentChallenge: string
  futureVision: string
  shareKnowledge: string
  personalLifeHelp: string
  name: string
  email: string
  linkedinUrl?: string
}
```

### AnalysisResult (Output da IA)
```typescript
{
  precisa_refazer?: boolean
  titulo_personalizado: string
  resumo_motivador: string
  mentores_sugeridos: Array<{
    tipo: string
    razao: string
    disponivel: boolean
    mentor_nome?: string
  }>
  conselhos_praticos: string[]
  proximos_passos: string[]
  areas_desenvolvimento: string[]
  mensagem_final: string
  potencial_mentor: boolean
  areas_vida_pessoal: string[]
}
```

### QuizResponse (Banco de Dados)
```typescript
{
  id: UUID
  name: string
  email: string
  linkedin_url?: string
  career_moment: string
  mentorship_experience: string
  development_areas: string[]
  current_challenge: string
  future_vision: string
  share_knowledge: string
  personal_life_help: string
  score: number
  ai_analysis: AnalysisResult (JSONB)
  processed_at: timestamp
  email_sent: boolean
  email_sent_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

---

## ๐ Seguranรงa e Polรญticas RLS

```sql
-- Qualquer um pode inserir (quiz pรบblico)
CREATE POLICY "Public can submit quiz responses"
  ON quiz_responses FOR INSERT TO public
  WITH CHECK (true);

-- Qualquer um pode ler por email
CREATE POLICY "Anyone can read responses by email"
  ON quiz_responses FOR SELECT TO public
  USING (true);

-- Qualquer um pode atualizar (para Edge Functions)
CREATE POLICY "Public can update quiz responses"
  ON quiz_responses FOR UPDATE TO public
  USING (true);
```

---

## โฑ๏ธ Fluxo Temporal

```
T0: Usuรกrio inicia quiz
    โ (0-5 min)
T1: Usuรกrio completa 8 perguntas
    โ (< 1s)
T2: Dados salvos no banco
    โ (< 1s)
T3: Email de convite enviado (async)
    โ (< 1s)
T4: Redirecionamento para /results
    โ (2-5s)
T5: Edge Function processa com IA
    โ (< 1s)
T6: Anรกlise salva no banco
    โ (< 1s)
T7: Email com resultados enviado
    โ (polling a cada 2s)
T8: Frontend detecta processed_at
    โ (instantรขneo)
T9: Resultados exibidos ao usuรกrio
```

**Tempo total:** ~5-10 segundos apรณs submit

---

## ๐ฏ Pontos de Integraรงรฃo

### Frontend โ Supabase Client
- `createClient()` - Cria cliente autenticado
- `.from('quiz_responses')` - Queries ao banco
- `.functions.invoke()` - Chama Edge Functions

### Edge Functions โ OpenAI
- `fetch('https://api.openai.com/v1/chat/completions')`
- Headers: Authorization Bearer token
- Body: messages com prompt estruturado
- Response: JSON com anรกlise

### Edge Functions โ Brevo
- `fetch('https://api.brevo.com/v3/smtp/email')`
- Headers: api-key
- Body: sender, to, subject, htmlContent
- Response: messageId

### Edge Functions โ Database
- Supabase Admin Client (service_role)
- Bypass RLS para operaรงรตes internas
- Transaรงรตes para consistรชncia

---

## ๐จ Tratamento de Erros

### Frontend
- Try/catch em handleQuizSubmit
- Toast de erro se falhar
- Nรฃo bloqueia se email de convite falhar

### Edge Functions
- Try/catch em cada funรงรฃo
- Fallback analysis se IA falhar
- Logs detalhados de erro
- Status HTTP apropriados

### Banco de Dados
- Constraints para validaรงรฃo
- Indexes para performance
- RLS para seguranรงa

---

## ๐ Retry e Resilรชncia

### Polling de Resultados
```typescript
if (!data.processed_at) {
  setTimeout(loadResults, 2000) // retry apรณs 2s
  return
}
```

### Fire & Forget
```typescript
// Email de convite nรฃo bloqueia
supabase.functions.invoke("send-invite-email")
  .catch(err => console.error(err))
```

### Fallback de IA
```typescript
// Se OpenAI falhar, usa anรกlise baseada em regras
if (analysisError) {
  analysisResult = generateFallbackAnalysis(response, mentors)
}
```

---

## ๐ Mรฉtricas e Monitoramento

### Queries รteis
```sql
-- Total de respostas
SELECT COUNT(*) FROM quiz_responses;

-- Pontuaรงรฃo mรฉdia
SELECT AVG(score) FROM quiz_responses WHERE score IS NOT NULL;

-- Taxa de processamento
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN processed_at IS NOT NULL THEN 1 ELSE 0 END) as processados,
  ROUND(100.0 * SUM(CASE WHEN processed_at IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*), 2) as taxa
FROM quiz_responses;

-- Taxa de envio de email
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN email_sent THEN 1 ELSE 0 END) as enviados,
  ROUND(100.0 * SUM(CASE WHEN email_sent THEN 1 ELSE 0 END) / COUNT(*), 2) as taxa_envio
FROM quiz_responses;
```

---

## ๐จ Para Visualizar no Excalidraw

Este arquivo pode ser usado como referรชncia para criar um diagrama visual no Excalidraw. Sugestรตes de elementos:

1. **Retรขngulos azuis** - Componentes Frontend
2. **Retรขngulos verdes** - Edge Functions
3. **Cilindros** - Banco de Dados
4. **Nuvens** - Serviรงos Externos (OpenAI, Brevo)
5. **Setas** - Fluxo de dados
6. **Cores** - Diferenciar camadas
7. **รcones** - Representar aรงรตes (๐ง email, ๐ค IA, ๐พ banco)

---

**Criado para:** Projeto MENVO - Sistema de Quiz com Anรกlise de IA
**รltima atualizaรงรฃo:** 2025-01-13
